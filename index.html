<html>
        <head>
            <style>
                body{
                    margin:0;
                    height : 100%;
                    width:100%;
                    font-family : monospace;
                }
                .container>div{
                    font-size:4vmin;
                }
                #output{
                    /* height: 320px;
                       width: 480px; */
                    /* margin: 0 10vh; */
                    border: 2px solid black;
                    border-radius: 10px;
                    display: flex;
                }
                input{
                    margin : 2vh 0;
                    width : 50vw;
                    height : 8vmin;
                    line-height: 8vmin;
                    margin-left : 25vw;
                    font-size : 4vmin;
                }

                .container{
                    width : 100vw;
                    height : auto;
                    display : flex;
                    flex-direction : column;
                }

                .container>div{
                    display:flex;
                    flex-direction: column;
                }
                .outputter{
                    width:90vw;
                    margin-left:5vw;
                }
                .inputter{
                    width:100vw;
                    margin-top : 2vh;
                    justify-content : space-evenly;
                }
                #pred{
                    margin : 5vh 0;
                    text-align : center;
                }
            </style>
            <!-- <script src="tf.min.js"></script> -->
            <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.1.266/build/pdf.min.js"></script>
            <script src="compressor.js"></script>
        </head>
        <body>
            <center>
                <div class='container'>
                    <div class='inputter'>
                        <input type="text" class='pnr' placeholder="policy number here">
                          <input type='text' class='flight_op' placeholder="flight op here">
                        <input type='text' class='flight_no' placeholder="flight_no here">
                        <input type="file" name="ima" id="file"  accept="application/pdf, image/*">
                        <input type="submit" id='submit'>
                    </div>  
                   <div class="outputter">
                    <div id="pred"></div>
                    <img id="output"/>	
                   </div>
                    
                </div>
            </center>

          
        </body>
        <script>
            inp = document.querySelector('#file');
             let p,q,r,dataUrl =[];
                const options = {
                    maxSizeMB:1,
                    maxWidthOrHeight: 1920,
                    useWebWorker: true
                }
                
                function urlMaker(file){
                    reader = new FileReader();
                    reader.onloadend = function () {
                        dataUrl.push(reader.result);
                    };
                    reader.readAsDataURL(file);
                }  
                
                async function streamer(file){
                    cf = await imageCompression(file, options); 
                    await urlMaker(cf);        
                };
      
            pnr = document.querySelector('.pnr')
            fno = document.querySelector('.flight_no')
            fop = document.querySelector('.flight_op')
           
            function pdfToPng(el) {
            file = el.files[0] 
            fileReader = new FileReader();
            fileReader.onload = function(ev) { 
                pdfjsLib.getDocument(fileReader.result).then(function getPdfHelloWorld(pdf) {
                    for(let i=1;i<=pdf.numPages;i++){
                        pdf.getPage(i).then(function getPageHelloWorld(page) {
                        var scale = 1.5;
                        var viewport = page.getViewport(scale);
                        var canvas = document.createElement('canvas');
                        canvas.style.display = "none";
                        el.appendChild(canvas);

                        var context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        var task = page.render({
                            canvasContext: context,
                            viewport: viewport
                        })
                        task.promise.then(function() {
                            let iimg = canvas.toDataURL('image/png');
                            dataUrl.push(iimg);
                            // changeColor(iimg, text_color)
                        });
                    });
                    }

                }, function(error) {
                    console.log(error);
                });
                };
        fileReader.readAsArrayBuffer(file);
    }

            var loadFile = async function(event) {
                dataUrl = [];
                const pred = document.querySelector('#pred');
                var image = document.getElementById('output');
                fileObj = event.target.files[0];
                // console.log(typeof(fileObj.type));
                if((fileObj.type=="image/png")||(fileObj.type=="image/jpg")||(fileObj.type=="image/jpeg"))
                {
                    
                    streamer(event.target.files[0]);
                    image.src = URL.createObjectURL(fileObj);
                }
                else if(fileObj.type=="application/pdf"){
                    pdfToPng(inp)
                }
                else{
                    console.log("none")
                }

                // const check = tf.browser.fromPixels(image).resizeNearestNeighbor([320, 480]).toFloat().expandDims();
                // console.log(check);
               

           
                // let blob = await fetch(image.src).then(r => r.blob());
                // dataUrl = await new Promise(resolve => {
                // let reader = new FileReader();
                // reader.onload = () => resolve(reader.result);
                // reader.readAsDataURL(blob);
                // })


                

                    // async function predictor() {
                    //     const model = await tf.loadLayersModel('model/model.json');
                    //     // model.summary();
                    //     const prediction = model.predict(check);
                    //     pred.innerText += prediction;
                    //     prediction.print();
                    // }
                    // predictor();
            }



            
            sub = document.querySelector('#submit');
            sub.onclick = async () =>{
                pred.innerText ='...';

                for(let i=0;i<dataUrl.length;i++)
                {
                    let data = {
                        "encoded_string": dataUrl[i],
                        "policy_no": p,
                        "flight_no": q,
                        "flight_op": r,
                        "doc_num" : (i+1).toString()
                    }

                    let response = await fetch('https://39u3b3cep7.execute-api.ap-south-1.amazonaws.com/prod/checker', {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json;charset=utf-8'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    let result = await response.json();
                    console.log(result);
                    pred.innerText+= "\n" + result.label + ' -->  ' + result.score;
                }
                
            }


            inp.onchange = () => {
                
                loadFile(event);
            }
            pnr.onchange = ()=> p = pnr.value;
            fno.onchange = ()=> q = fno.value;
            fop.onchange = ()=> r = fop.value;
            
        </script>
</html>